<script src="./assets/js/dagre.js"></script>
<script src="./assets/js/nomnoml.js"></script>
<script src="./assets/js/custom.js"></script>

# membership-form

---

## Running

Small backend to process the leads generated by the main site as well as the membership applicants.

It contains a `POST` endpoint where data is sent, which is then parsed and stored in a database table according to the kind of data.

It also contains an email handler to process the verification of accounts.

Install and run the program:

```bash
npm install
npm run execute
```

## Program flow

Data sent in a POST request as `application/JSON` with the correct headers, and given the content of the `query-kind` header, the data is processed differently.

<div class="diagram" id="steps-diagram"></div>

<script>
    var source = `

# title: Steps Taken Diagram
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: down
# zoom: 0.5
# ranker: longest-path

    [<start>s] -> [Data is received]
    [Data is received] -> [<choice>It's good?]
    [<choice>It's good?] yes -> [Data is parsed]
    [<choice>It's good?] no -> [Redirect to error page]
    [Redirect to error page] -> [<end>1]

    [Data is parsed] -> [Check header]
    [Check header] -> [leadgen]
    [Check header] -> [verification]
    [Check header] -> [membership]

`;
    document.getElementById("steps-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

One possibility is to trigger the `leadgen` pathway, where the data is recorded to a database, a verification email is sent and the user is redirected to the adequate page.

<div class="diagram" id="leadgen-diagram"></div>

<script>
    var source = `

# title: Steps Taken Diagram (leadgen)
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: down
# zoom: 0.5
# ranker: longest-path

    [leadgen] -> [<choice>Is leadgen data good?]
    [<choice>Is leadgen data good?] yes -> [Write leadgen data into the database]
    [<choice>Is leadgen data good?] no -> [Redirect to error page]
    [Write leadgen data into the database] -> [Send verification email]
    [Send verification email] -> [Redirect to success page]
    [Redirect to error page] -> [<end>1]
    [Redirect to success page] -> [<end>2]

`;
    document.getElementById("leadgen-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

Another is the `verification` pathway where the user is validated in the database with a (hopefully) unique token. Once verified, the user is sent another email welcoming them to the club, giving some info and asking if they want to apply for a membership.

<div class="diagram" id="verification-diagram"></div>

<script>
    var source = `

# title: Steps Taken Diagram (verification)
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: down
# zoom: 0.5
# ranker: longest-path

    [verification] -> [<choice>Is verification data good?]
    [<choice>Is verification data good?] yes -> [Generate UID and write it into the database]
    [<choice>Is verification data good?] no -> [Redirect to error page]
    [Generate UID and write it into the database] -> [Send info/welcome email]
    [Send info/welcome email] ->  [Redirect to success page]
    [Redirect to error page] -> [<end>1]
    [Redirect to success page] -> [<end>2]

`;
    document.getElementById("verification-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

If they do, the `membership` pathway is used, where it's verified that the data sent matches a verified user in the database, and then the new data is recorded to another part of the database, and finally an email is sent congratulating the user for applying.

<div class="diagram" id="membership-diagram"></div>

<script>
    var source = `

# title: Steps Taken Diagram (membership)
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: down
# zoom: 0.5
# ranker: longest-path

    [membership] -> [<choice>Is membership data good?]
    [<choice>Is membership data good?] yes -> [<choice>Is the user verified?]
    [<choice>Is the user verified?] yes -> [Write membership data into the database]
    [<choice>Is the user verified?] no -> [Redirect to error page]
    [Write membership data into the database] -> [Send congratulations/info email]
    [Send congratulations/info email] -> [Redirect to success page]
    [<choice>Is membership data good?] no -> [Redirect to error page]
    [Redirect to error page] -> [<end>1]
    [Redirect to success page] -> [<end>2]

`;
    document.getElementById("membership-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

## Folder structure

<div class="diagram" id="main-hierarchy-diagram"></div>

<script>
    var source = `

# title: Main File Hierarchy Diagram
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: right
# .filename: fill=#ccc

    [Main Root] -> [<filename>/]
    [<filename>/] -> [Source Folder]
    [Source Folder] -> [<filename>./src]
    [<filename>/] -> [Documentation]
    [Documentation] -> [<filename>./docs]
    [Documentation] -> [<filename>./docsDependencies]
    [Documentation] -> [<filename>./typedocTheme]
    [<filename>/] -> [Compiled files]
    [Compiled files] -> [<filename>./build]
    [<filename>/] -> [Databases]
    [Databases] -> [<filename>./db]
    [<filename>/] -> [Config files]
`;
    document.getElementById("main-hierarchy-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

### Databases - `./db`

The databases folder contains the database file used/created by SQLite, and a subfolder, `./db/tables`, that contains the definitions of the tables
used in the database; they are defined as `JSON` files, where inside each one is an array of objects cointaining two properties, with the keys `column` and `datatype`. Predictably, the data corresponding to the `column` keys contains a string with the name of the column. Likewise, `datatype` contains the datatype assigned to the fields in that column.

The idea behind this is to avoid hardcoding stuff into the code, and making it easier to modify the tables structure in the future as is needed, even by someone completely alien to this repo. It also allows to avoid mistakes by having everything as key-value pairs instead of a plain string with the SQL statement (The SQL statement is constructed using the data present in this files).

### Documentation - `./docs`, `./docsDependencies` and `./typedocTheme`

In the `./docs` folder lives all the docs compiled by TypeDoc. This folder is then available as the GitHub Page of this repo, [This one](https://aordano.github.io/membership-form/), so anyone can explore everything on the program. (In fact this is the mainb README of the repo, but it is copied to the docs landing page so you may be reading it there already).

The other two folders contain `JS` needed by the docs to do stuff like the diagrams, and styling, respectively.

### Compiled Files - `./build`

Here lives the site, you could run `npm run build` to just build it and then copy it to other place to be served. This uses [ExpressJS](http://expresjs.org), so it is capable of straight running without need to further processing.

### Config Files

This project uses:

- Prettier
- ESLint
- NodeJS
- TypeScript
- Git (obviously)

Therefore there's related config files present in the root of the repo:

- Prettier
  - `.prettierrc`
- ESLint
  - `.eslintrc.json`
  - `.eslintignore`
- NodeJS
  - `package.json`
- TypeScript
  - `tsconfig.json`
- Git (obviously)
  - `.gitignore`

Also there's present a `.vscode` folder, that intentionally was not left out version control. This folder contains project-specific config needed by ESLint, and also a `launch.json` file to open a debug session.

## Source - `./src`

This is where all the gravy and flavor resides. Instead of just throwing everything up in a quick file, the project is split in different modules that perform specific functions, so it's easy to understand what are you editing, what does what and everything's cleaner.

<div class="diagram" id="src-hierarchy-diagram"></div>

<script>
    var source = `

# title: Source Files Hierarchy Diagram
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: down
# .filename: fill=#ccc

    [<filename>./src] -> [Web Routes]
    [<filename>./src] -> [Types]
    [<filename>./src] -> [Support files]
    [<filename>./src] -> [Execution logic]

    [Web Routes] -> [<filename>./src/routes]
    [Types] -> [<filename>./src/types]
    [Support files] -> [<filename>./src/utils]
    [Execution logic] -> [<filename>./src/logic]
`;
    document.getElementById("src-hierarchy-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

### Support files - `./src/utils`

<div class="diagram" id="src-utils-hierarchy-diagram"></div>

<script>
    var source = `

# title: Support Files Hierarchy Diagram
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: down
# .filename: fill=#ccc
# .ts: fill=#5498E3

    [<filename>./src/utils] -> [<ts>db]
    [<filename>./src/utils] -> [<ts>functions]
    [<filename>./src/utils] -> [<ts>index]
`;
    document.getElementById("src-utils-hierarchy-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

This are classes and functions that abstract, clean or simplify stuff, so when the stuff has to be done, it is clean and easy to follow.

- `db.ts`: [See the relevant docs page](https://aordano.github.io/membership-form/modules/_utils_db_.html)
- `functions.ts`: [See the relevant docs page](https://aordano.github.io/membership-form/modules/_utils_functions_.html)
- `index.ts`: [See the relevant docs page](https://aordano.github.io/membership-form/modules/_utils_index_.html)

### Types - `./src/types`

The typings used through the project. Nothing fancy.

- `index.ts`: [See the relevant docs page](https://aordano.github.io/membership-form/modules/_types_index_.html)

### Web routes - `./src/routes`

The web routes that express will route to. There's only one because it discriminates based on headers not on the route itself.

- `index.ts`: [See the relevant docs page](https://aordano.github.io/membership-form/modules/_routes_index_.html)

### Execution logic - `./src/logic`

<div class="diagram" id="src-logic-hierarchy-diagram"></div>

<script>
    var source = `

# title: Execution logic Files Hierarchy Diagram
# stroke: #333333
# fill: #C9C0FF; D9D0FF
# lineWidth: 2
# bendSize: 2
# edges: rounded
# direction: down
# .filename: fill=#ccc
# .ts: fill=#5498E3

    [<filename>./src/logic] -> [<ts>db]
    [<filename>./srclogic] -> [<ts>email]
`;
    document.getElementById("src-logic-hierarchy-diagram").appendChild(HTMLStringToElement(nomnoml.renderSvg(source)));
</script>

- `db.ts`: [See the relevant docs page](https://aordano.github.io/membership-form/modules/_logic_db_.html)
- `email.ts` (**WIP**): [See the relevant docs page](https://aordano.github.io/membership-form/modules/_logic_email_.html)

## Powered by

- [TypeScript](https://typescriptlang.org)
- [NodeJS](https://nodejs.org)
- [TypeDoc](https://typedoc.org)
- [SQLite 3](https://sqlite.org)
- Love and cookies
